---
title: "HGDP1KG"
author: "Jennifer Blanc"
date: "2024-07-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(tidyverse)
library(maps)
library(latex2exp)
```

# Construct GWAS and Test Panels 


### Initial look at meta data

```{r}
# Read in data
df <- fread("../data/HGDP1KG/gnomad_meta_updated.tsv", sep = "\t")

# Select relevant columns (for now)
dfFilter <- df %>% select("s","project_meta.project_subpop" , "latitude" ,  "longitude",
                   "population",  "region", "project_meta.project_pop")
colnames(dfFilter)[1] <- "IID"

# Plot data by lat and long
world_map <- map_data("world")
pl <- ggplot() + geom_polygon(data = world_map, aes(x = long, y = lat, group = group), fill = "white", color = "black") + geom_point(data = dfFilter, aes(x = longitude, y = latitude, color = project_meta.project_pop), size = 2) +
  theme_minimal(base_size = 14) + xlab("Longitude") + ylab("Latitude") +labs(colour="POP") + theme(legend.position = "bottom")
pl
```

### Select different test panels 

**Longitude (and Latitude) in Eurasia**

Similar to the analysis in [Berg et al](https://elifesciences.org/articles/39725) we want to test for polygenic selection along longitude for populations in Eurasia (N = 2,224).   
- EAS: 825  
- FIN: 99  
- NFE: 510 (note we removed CEU samples because their lat/long corresponds to sample collection in Utah)   
- SAS: 790 

```{r}
# Select Eurasian Sample
dfEurAsia <- dfFilter %>% filter(project_meta.project_pop %in% c("fin", "nfe", "eas", "sas")) %>% 
  filter(population != "CEU") # Remove CEU due to LAT/LONG on AMERICA
dfEurAsia <- dfEurAsia %>% select("IID", "project_meta.project_pop", "population","latitude", "longitude")
colnames(dfEurAsia) <- c("IID","pop", "subpop", "lat", "long")
dfEurAsia <- dfEurAsia %>% mutate(FID = 0) %>% select(FID, everything())

# Save IDs 
fwrite(dfEurAsia,"../data/HGDP1KG/ids/test_ids/eurasia.txt", row.names = F, col.names = T, quote = F, sep = "\t")

# Plot Map
pl <- ggplot() + geom_polygon(data = world_map, aes(x = long, y = lat, group = group), fill = "white", color = "black") +
  geom_point(data = dfEurAsia, aes(x = long, y = lat, color = pop), size = 2) + 
  theme_minimal(base_size = 14) + xlab("Longitude") + ylab("Latitude") +labs(colour="POP") + theme(legend.position = "bottom")

ggsave("~/Desktop/tmp.png", pl, height = 5)
```

**Latitude (and Longitude) in Europe**

Similar to the analysis in [Berg et al](https://elifesciences.org/articles/39725) we want to test for polygenic selection along latitude for populations in Europe (N = 510).   
- NFE: 510 (note we removed CEU samples because their lat/long corresponds to sample collection in Utah)   

```{r}
# Select Eurasian Sample
dfEur <- dfFilter %>% filter(project_meta.project_pop %in% c("nfe"))
dfEur <- dfEur %>% select("IID", "project_meta.project_pop", "population", "latitude", "longitude") %>% 
  filter(population != "CEU")
colnames(dfEur) <- c("IID","pop", "subpop", "lat", "long")
dfEur <- dfEur %>% mutate(FID = 0) %>% select(FID, everything())

# Save IDs 
fwrite(dfEur,"../data/HGDP1KG/ids/test_ids/nfe_no_ceu.txt", row.names = F, col.names = T, quote = F, sep = "\t")

# Plot Map 
pl <- ggplot() + geom_polygon(data = world_map, aes(x = long, y = lat, group = group), fill = "white", color = "black") +
  geom_point(data = dfEur, aes(x = long, y = lat, color = subpop), size = 2) + 
  theme_minimal(base_size = 14) + xlab("Longitude") + ylab("Latitude") +labs(colour="POP") + theme(legend.position = "bottom")

ggsave("~/Desktop/tmp.png", pl, height = 5)
```
**Sardinia vs Europe**

Similar to the analysis in [Chen et al](https://www.sciencedirect.com/science/article/pii/S0002929720301610) we want to test for polygenic selection acting on height in Sardinia compared to the rest of Europe.   
- NFE: 689 (including CEU)   

```{r}
# Select Eurasian Sample
dfEur <- dfFilter %>% filter(project_meta.project_pop %in% c("nfe"))
dfEur <- dfEur %>% select("IID", "project_meta.project_pop", "population","latitude", "longitude") 
colnames(dfEur) <- c("IID", "pop", "subpop", "lat", "long")
dfEur <- dfEur %>% mutate(SDI = case_when(subpop == "Sardinian" ~ "sdi", TRUE ~ "eur")) %>% select(IID, SDI, everything())
dfEur <- dfEur %>% mutate(FID = 0) %>% select(FID, everything())

# Save IDs 
fwrite(dfEur,"../data/HGDP1KG/ids/test_ids/nfe.txt", row.names = F, col.names = T, quote = F, sep = "\t")

# Plot Map 
pl <- ggplot() + geom_polygon(data = world_map, aes(x = long, y = lat, group = group), fill = "white", color = "black") +
  geom_point(data = dfEur, aes(x = long, y = lat, color = SDI), size = 2) + 
  theme_minimal(base_size = 14) + xlab("Longitude") + ylab("Latitude") +labs(colour="POP") + theme(legend.position = "bottom")
ggsave("~/Desktop/tmp.png", height = 5)
```
**All continental differences**  

Here we include the 5 major populations and will test for overlap in "continental" level contrasts (N = 3,859).  
- EAS: 825  
- NFE:  689 
- SAS: 790  
- AFR: 1003  
- AMR: 552  

```{r}
dfAll <- dfFilter %>%  filter(project_meta.project_pop %in% c("nfe", "afr", "amr", "eas", "sas")) %>% select("IID","project_meta.project_pop", "population", "latitude", "longitude")
colnames(dfAll) <- c("IID", "pop", "subpop", "lat", "long")
dfAll <- dfAll %>% mutate(FID = 0) %>% select(FID, everything())

# Save IDs 
fwrite(dfAll,"../data/HGDP1KG/ids/test_ids/all.txt", row.names = F, col.names = T, quote = F, sep = "\t")
```


### Sample GWAS Panels 

#### Explore PCA of Whole Biobank

Plot PC1 vs PC2 colored by self-identified ethnic background
```{r, warning=FALSE}
# Load data and combine
dfPCA <- fread("../endpoints/ukbb/whole_biobank.eigenvec.gz")
dfEB <- fread("../endpoints/ukbb/EthnicBackground_21000.txt")
df <- inner_join(dfPCA, dfEB)

# Use continental labels 
df <- df %>% mutate(continental = case_when(EthnicBackground_21000 %in% c(4, 4001, 4002, 4003) ~ "Africa", EthnicBackground_21000 %in% c(1, 1001, 1002, 1003) ~ "Europe", EthnicBackground_21000 %in% c(2, 2001, 2002, 2003, 2004) ~ "Mixed", EthnicBackground_21000 %in% c(3, 3001, 3002, 3003, 3004) ~ "Asia"))
```

```{r, cache=TRUE}
# Make PCA plot color based on self identified Ethnic background
ggplot(data = df, aes(x = PC1, y = PC2, color = continental)) + geom_point() + theme_classic(base_size = 14) + scale_color_manual(values = c("darkred", "navy", "goldenrod4", "gray50"), na.value = "gray70")
```

#### Pre-defined sets  

First use two predefined sets:  
- ALL: all genotyped individuals in the UKBB ($M = 486,670$)  
- WBS ("White British Subset"): all individuals the UKBB assigned to be part of the WBS ($M=408,812$)  

```{r, warning=FALSE}
df <- df %>% mutate(POP = continental)

# Use all genotyped individuals 
dfALL <- df %>% select("#FID", "IID", "POP")
#fwrite(dfALL,"../data/ids/gwas_ids/ALL.txt", row.names = F, col.names = T, quote = F, sep = "\t")

# Use only WBS 
WBS <- fread("../data/ukbb/WBS.ids")
dfWBS <- inner_join(df, WBS) %>% select("#FID", "IID", "POP")
#fwrite(dfWBS,"../data/ids/gwas_ids/WBS.txt", row.names = F, col.names = T, quote = F, sep = "\t")
```


#### Use PC distance

First I calculate the euclidean distance of each individual from the mean position on PC1 and PC2 for the WBS. Using this distance metric I select $M=10,000$ individuals for 4 different GWAS panels based on their distance from the WBS:  

- q1: individuals in the first fourth of the total distance  
- q2: individuals in the first half of distance  
- q3: individuals in the three-fourths of total distance  
- q4: individuals in any distance (equivalent to sampling 10,000 individuals from ALL)   


```{r, warning=FALSE}
# Get average of WBS
dfWBS <- inner_join(df, WBS)
avgPC1 <- mean(dfWBS$PC1)
avgPC2 <- mean(dfWBS$PC2)

# Calculate from WBS centroid 
avgPC <- c(avgPC1, avgPC2)
df$distance <- sqrt(rowSums((df[, 3:4] - avgPC)^2))

# Plot distance
pl <- ggplot(data = df, aes(x = distance, y = PC1, color = POP)) + geom_point() + theme_classic(base_size = 14) + scale_color_manual(values = c("darkred", "navy", "goldenrod4", "gray50"), na.value = "gray70")
ggsave("~/Desktop/tmp.png", pl)
```

```{r, eval=FALSE}
set.seed(1212)
# Sample GWAS panels
maxDist <- max(df$distance)
interval <- maxDist / 4
q1 <- interval
q2 <- interval * 2
q3 <- interval * 3
q4 <- interval * 4

## Sample everyone 
dfGWAS <- df %>% filter(distance <=  q4) %>% sample_n(10000) %>% select("#FID", "IID", "POP")
#fwrite(dfGWAS,"../data/ids/gwas_ids/q4.txt", row.names = F, col.names = T, quote = F, sep = "\t")

## Sample q3
dfGWAS <- df %>% filter(distance <=  q3)%>% sample_n(10000) %>% select("#FID", "IID", "POP")
#fwrite(dfGWAS,"../data/ids/gwas_ids/q3.txt", row.names = F, col.names = T, quote = F, sep = "\t")

## Sample q4
dfGWAS <- df %>% filter(distance <=  q2)%>% sample_n(10000) %>% select("#FID", "IID", "POP")
#fwrite(dfGWAS,"../data/ids/gwas_ids/q2.txt", row.names = F, col.names = T, quote = F, sep = "\t")

## 1st quartile
dfGWAS <- df %>% filter(distance <=  q1)%>% sample_n(10000) %>% select("#FID", "IID", "POP")
#fwrite(dfGWAS,"../data/ids/gwas_ids/q1.txt", row.names = F, col.names = T, quote = F, sep = "\t")
```


# Results 

## Continental Constrasts

### Overlap Statistics

Load data and format 
```{r}
dfOverlap <- fread("../endpoints/HGDP1KG/OverlapStats.txt")
#dfOverlap <- fread("../endpoints/InUKBB/OverlapStats.txt")
dfOverlap <- dfOverlap %>% mutate(gwas_type2 = case_when(gwas %in% c("q1", "q2", "q3", "q4") ~ "distance",
         gwas %in% c("ALL", "WBS") ~ "full"))
dfOverlap$gwas <- factor(dfOverlap$gwas, levels = c("ALL", "WBS", "q1", "q2", "q3", "q4"))
#dfOverlap <- dfOverlap %>% filter(contrasts == "eurasia-lat" | contrasts == "eurasia-long")


```

```{r}
dfPC <- fread("../endpoints/HGDP1KG/PCStats.txt")
#dfPC <- fread("../endpoints/InUKBB/PCStats.txt")
dfPC <- dfPC %>% mutate(gwas_type2 = case_when(gwas %in% c("q1", "q2", "q3", "q4") ~ "distance",
         gwas %in% c("ALL", "WBS") ~ "full"))
dfPC$gwas <- factor(dfPC$gwas, levels = c("ALL", "WBS", "q1", "q2", "q3", "q4"))
dfPC <- dfPC %>% filter(contrasts == "eur-lat" | contrasts == "eur-long")
#dfPC <- dfPC %>% filter(contrasts == "sdi-eur" )
```

**GWAS type vs proportion of variance explained** 
```{r}
pl <- dfOverlap %>% filter(L == "pruneall")%>% ggplot(aes(x = gwas, y = Z, fill = gwas_type2)) + geom_bar(stat = "identity") + xlab("GWAS Type") + ylab("Proportion of variance explained (Z)") + theme_bw(base_size = 14) + scale_fill_manual(values = c("purple4", "lightseagreen"))  + guides(fill="none") + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 10, angle = 45))+facet_wrap(~contrasts, nrow = 2) 
pl

ggsave("~/Desktop/tmp.png",pl,  height = 5)
```

```{r}
pl <- dfOverlap %>% filter(L == "pruneall")%>% ggplot(aes(x = contrasts, y = Z, fill = gwas_type2)) + geom_bar(stat = "identity") + xlab("Contrast") + ylab("Proportion of variance explained (Z)") + theme_bw(base_size = 14)  + guides(fill="none") + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 10, angle = 90 )) + facet_wrap(~gwas, nrow = 2, scales = "free") + scale_fill_manual(values = c("purple4", "lightseagreen"))
pl
ggsave("~/Desktop/tmp.png",pl, height = 10, width = 10)
```


```{r}
dfPlot <- dfPC %>% filter(gwas_type == "all" & test_type == "all", L == "pruneall", contrasts == "nfe-afr") %>% group_by(gwas) %>% mutate(cumVarExp = cumsum(VarExp)) %>% ungroup()

pl <- ggplot(data = dfPlot, aes(x = PC, y = cumVarExp, fill = gwas_type2)) + geom_bar(stat = "identity") + facet_wrap(~gwas, nrow = 2, scales = "free") + ylab("Cummulative prop. variance explained")  + theme_bw(base_size = 14)  + guides(fill="none") + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 10 )) + scale_fill_manual(values = c("purple4", "lightseagreen"))
pl

ggsave("~/Desktop/tmp.png",pl)
```

```{r}
pl <- dfOverlap %>% filter(L == "pruneall") %>% ggplot(aes(x = contrasts, y = error, color = gwas_type2)) + geom_point() + facet_wrap(~gwas, nrow =2) + theme_bw(base_size = 14) + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 10,angle = 45, hjust = 1)) + scale_color_manual(values = c("purple4", "lightseagreen"))  + guides(color ="none") + xlab("") + ylim(0,1)
pl
ggsave("~/Desktop/tmp.png",pl,  height = 5)
```

```{r}
pl <- dfOverlap %>% filter(L == "pruneall") %>% ggplot(aes(x = gwas, y = error, color = gwas_type2)) + geom_point(size = 3) + theme_bw(base_size = 14) + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 10,angle = 45, hjust = 1)) + scale_color_manual(values = c("purple4", "lightseagreen"))  + guides(color ="none") + xlab("") + ylim(0,1) + facet_wrap(~contrasts)
pl
ggsave("~/Desktop/tmp.png",pl,  height = 5)
```


```{r}
pl <- dfOverlap %>% filter(L != "pruneall" & gwas == "WBS") %>% mutate(L= as.numeric(as.character(L))) %>% ggplot(aes(x = L, y = error)) + geom_point(color = "lightseagreen") + facet_wrap(~contrasts, nrow =2) + scale_x_log10()  + theme_bw(base_size = 14) + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 10,angle = 45, hjust = 1)) + ggtitle("WBS") + geom_hline(yintercept = 1, color = "red")
pl
ggsave("~/Desktop/tmp.png",pl,  height = 5)
```

```{r}
pl <- dfOverlap %>% filter(L == "pruneall") %>% ggplot(aes(x = Z, y = error, shape = gwas, color = contrasts)) + geom_point() + theme_bw(base_size = 14) + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 10,angle = 45, hjust = 1)) + xlab("Proportion of variance explained (Z)") + scale_x_log10() + scale_y_log10() + guides(color = guide_legend(ncol = 2),shape = guide_legend(ncol = 2)
)
pl

ggsave("~/Desktop/tmp.png",pl,  height = 4, width = 10)
```



```{r}
pl <- dfPC %>% filter(gwas_type == "even" & test_type == "odd" & L == "pruneall" & PC <= 10)%>% ggplot(aes(x = PC, y = B2)) + geom_bar(stat = "identity", fill = "darkgreen", color = "darkgreen") + facet_grid(vars(gwas), vars(contrasts)) + theme_bw(base_size = 8) + ylab(TeX("$B_{i}^2$"))  + theme(plot.title = element_text(hjust = 0.5))+ scale_x_continuous(breaks = seq(0, 10, by = 5))
pl

ggsave("~/Desktop/tmp.png",pl,  height = 4)
```



```{r}
pl <- dfPC %>% filter(gwas_type == "even" & test_type == "odd" & L == "pruneall") %>% ggplot(aes(x = PC, y = r2)) + geom_bar(stat = "identity", fill = "darkgreen", color = "darkgreen") + facet_grid(vars(gwas), vars(contrasts)) + theme_bw(base_size = 8) + ylab(TeX("$R_{K}^2$")) + geom_hline( aes(yintercept = 1-Error), color = "red", linetype = 2, linewidth = 1) + scale_x_continuous(breaks = seq(0, 40, by = 10)) + theme(axis.text.x = element_text(size = 6), plot.title = element_text(hjust = 0.5)) + ylim(-0.1,1)
pl

ggsave("~/Desktop/tmp.png",pl,  height = 4)
```


```{r}
dfQ <- fread("../endpoints/HGDP1KG/QStats.txt")

pl <- dfQ %>% filter(covar == "no-FGr", contrasts %in% c("eur-lat", "eur-long"))%>% ggplot(aes(x = gwas, y = q, fill = as.character(pc))) + geom_bar(stat="identity") + facet_grid(vars(pc),vars(contrasts)) + theme_bw(base_size = 10) + theme(axis.text.x = element_text(size = 6, angle =45), plot.title = element_text(hjust = 0.5), legend.position = "none")+ scale_fill_manual(values= c("pink4", "blue4"))
pl
ggsave("~/Desktop/tmp.png",pl,  height = 4)
```



