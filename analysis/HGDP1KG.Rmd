---
title: "HGDP1KG"
author: "Jennifer Blanc"
date: "2024-07-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(tidyverse)
library(maps)
library(latex2exp)
```

# Construct Test Panel

### Initial look at meta data

```{r}
# Read in data
df <- fread("../data/HGDP1KG/gnomad_meta_updated.tsv", sep = "\t")

# Select relevant columns (for now)
dfFilter <- df %>% select("s","project_meta.project_subpop" , "latitude" ,  "longitude",
                   "population",  "region", "project_meta.project_pop")
colnames(dfFilter)[1] <- "IID"

# Plot data by lat and long
world_map <- map_data("world")
pl <- ggplot() + geom_polygon(data = world_map, aes(x = long, y = lat, group = group), fill = "white", color = "black") + geom_point(data = dfFilter, aes(x = longitude, y = latitude, color = project_meta.project_pop), size = 2) +
  theme_minimal(base_size = 14) + xlab("Longitude") + ylab("Latitude") +labs(colour="POP") + theme(legend.position = "bottom")
pl
```

### Select different test panels 

**Longitude (and Latitude) in Eurasia**

Similar to the analysis in [Berg et al](https://elifesciences.org/articles/39725) we want to test for polygenic selection along longitude for populations in Eurasia (N = 2,224).   
- EAS: 825  
- FIN: 99  
- NFE: 510 (note we removed CEU samples because their lat/long corresponds to sample collection in Utah)   
- SAS: 790 

```{r}
# Select Eurasian Sample
dfEurAsia <- dfFilter %>% filter(project_meta.project_pop %in% c("fin", "nfe", "eas", "sas")) %>% 
  filter(population != "CEU") # Remove CEU due to LAT/LONG on AMERICA
dfEurAsia <- dfEurAsia %>% select("IID", "project_meta.project_pop", "population","latitude", "longitude")
colnames(dfEurAsia) <- c("IID","pop", "subpop", "lat", "long")
dfEurAsia <- dfEurAsia %>% mutate(FID = 0) %>% select(FID, everything())

# Save IDs 
fwrite(dfEurAsia,"../data/HGDP1KG/ids/test_ids/eurasia.txt", row.names = F, col.names = T, quote = F, sep = "\t")

# Plot Map
pl <- ggplot() + geom_polygon(data = world_map, aes(x = long, y = lat, group = group), fill = "white", color = "black") +
  geom_point(data = dfEurAsia, aes(x = long, y = lat, color = pop), size = 2) + 
  theme_minimal(base_size = 14) + xlab("Longitude") + ylab("Latitude") +labs(colour="POP") + theme(legend.position = "bottom")

ggsave("~/Desktop/tmp.png", pl, height = 5)
```

**Latitude (and Longitude) in Europe**

Similar to the analysis in [Berg et al](https://elifesciences.org/articles/39725) we want to test for polygenic selection along latitude for populations in Europe (N = 510).   
- NFE: 510 (note we removed CEU samples because their lat/long corresponds to sample collection in Utah)   

```{r}
# Select Eurasian Sample
dfEur <- dfFilter %>% filter(project_meta.project_pop %in% c("nfe"))
dfEur <- dfEur %>% select("IID", "project_meta.project_pop", "population", "latitude", "longitude") %>% 
  filter(population != "CEU")
colnames(dfEur) <- c("IID","pop", "subpop", "lat", "long")
dfEur <- dfEur %>% mutate(FID = 0) %>% select(FID, everything())

# Save IDs 
fwrite(dfEur,"../data/HGDP1KG/ids/test_ids/nfe_no_ceu.txt", row.names = F, col.names = T, quote = F, sep = "\t")

# Plot Map 
pl <- ggplot() + geom_polygon(data = world_map, aes(x = long, y = lat, group = group), fill = "white", color = "black") +
  geom_point(data = dfEur, aes(x = long, y = lat, color = subpop), size = 2) + 
  theme_minimal(base_size = 14) + xlab("Longitude") + ylab("Latitude") +labs(colour="POP") + theme(legend.position = "bottom")

ggsave("~/Desktop/tmp.png", pl, height = 5)
```
**Sardinia vs Europe**

Similar to the analysis in [Chen et al](https://www.sciencedirect.com/science/article/pii/S0002929720301610) we want to test for polygenic selection acting on height in Sardinia compared to the rest of Europe.   
- NFE: 689 (including CEU)   

```{r}
# Select Eurasian Sample
dfEur <- dfFilter %>% filter(project_meta.project_pop %in% c("nfe"))
dfEur <- dfEur %>% select("IID", "project_meta.project_pop", "population","latitude", "longitude") 
colnames(dfEur) <- c("IID", "pop", "subpop", "lat", "long")
dfEur <- dfEur %>% mutate(SDI = case_when(subpop == "Sardinian" ~ "sdi", TRUE ~ "eur")) %>% select(IID, SDI, everything())
dfEur <- dfEur %>% mutate(FID = 0) %>% select(FID, everything())

# Save IDs 
fwrite(dfEur,"../data/HGDP1KG/ids/test_ids/nfe.txt", row.names = F, col.names = T, quote = F, sep = "\t")

# Plot Map 
pl <- ggplot() + geom_polygon(data = world_map, aes(x = long, y = lat, group = group), fill = "white", color = "black") +
  geom_point(data = dfEur, aes(x = long, y = lat, color = SDI), size = 2) + 
  theme_minimal(base_size = 14) + xlab("Longitude") + ylab("Latitude") +labs(colour="POP") + theme(legend.position = "bottom")
ggsave("~/Desktop/tmp.png", height = 5)
```
**All continental differences**  

Here we include the 5 major populations and will test for overlap in "continental" level contrasts (N = 3,859).  
- EAS: 825  
- NFE:  689 
- SAS: 790  
- AFR: 1003  
- AMR: 552  

```{r}
dfAll <- dfFilter %>%  filter(project_meta.project_pop %in% c("nfe", "afr", "amr", "eas", "sas")) %>% select("IID","project_meta.project_pop", "population", "latitude", "longitude")
colnames(dfAll) <- c("IID", "pop", "subpop", "lat", "long")
dfAll <- dfAll %>% mutate(FID = 0) %>% select(FID, everything())

# Save IDs 
#fwrite(dfAll,"../data/HGDP1KG/ids/test_ids/all.txt", row.names = F, col.names = T, quote = F, sep = "\t")
```


# Results 

## Continental Constrasts

Load data and format 
```{r}
dfOverlap <- fread("../endpoints/HGDP1KG/OverlapStats.txt") %>% separate(gwas, into = c("tmp", "gwas"), sep = "e")
dfOverlap$gwas <- factor(dfOverlap$gwas, levels = c( "5", "10", "50", "200")) 
dfOverlap <- dfOverlap %>% filter(contrasts %in% c("eas-nfe","eas-sas","eas-afr", "eas-amr", "nfe-sas","nfe-afr", "nfe-amr","sas-afr", "sas-amr", "afr-amr"))
dfOverlap$contrasts <- factor(dfOverlap$contrasts, levels = c("eas-nfe","eas-sas","eas-afr", "eas-amr", "nfe-sas","nfe-afr", "nfe-amr","sas-afr", "sas-amr", "afr-amr"))
```

```{r}
dfPC <- fread("../endpoints/HGDP1KG/PCStats.txt")
dfPC$gwas <- factor(dfPC$gwas, levels = c("e5", "e10", "e50", "e200"))
dfPC <- dfPC %>% filter(contrasts %in% c("eas-nfe","eas-sas","eas-afr", "eas-amr", "nfe-sas","nfe-afr", "nfe-amr","sas-afr", "sas-amr", "afr-amr"))
```


**GWAS type vs proportion of variance explained** 
```{r}
pl <- dfOverlap %>% filter(L == "pruneall")%>% ggplot(aes(x = gwas, y = Z)) + geom_point() + xlab("") + ylab("") + theme_bw(base_size = 14)  + guides(fill="none") + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 10))+facet_wrap(~contrasts, nrow = 1)+ scale_y_log10() 
pl
ggsave("~/Desktop/tmp.png", pl, height = 2, width = 12)
```


```{r}
dfOverlap %>% filter(L == "pruneall") %>% ggplot(aes(x = gwas, y =error)) + geom_point() + theme_bw(base_size = 14) + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 10))   + guides(color ="none") + xlab("") + facet_wrap(~contrasts, nrow = 1) + scale_y_log10()+ xlab("Sampling distance")
```

```{r}
pl <- dfOverlap %>% filter(L == "pruneall") %>% ggplot(aes(x = Z, y = error, shape = gwas, color = contrasts)) + geom_point() + theme_bw(base_size = 14) + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 10,angle = 45, hjust = 1)) + xlab("Proportion of variance explained (Z)") + scale_x_log10() + scale_y_log10() + guides(color = guide_legend(ncol = 2),shape = guide_legend(ncol = 2)
)
pl
```

```{r}
pl <- dfPC %>% filter(gwas_type == "even" & test_type == "odd" & L == "pruneall" & PC <= 10)%>% ggplot(aes(x = PC, y = B2)) + geom_bar(stat = "identity", fill = "darkgreen", color = "darkgreen") + facet_grid(vars(gwas), vars(contrasts)) + theme_bw(base_size = 8) + ylab(TeX("$B_{i}^2$"))  + theme(plot.title = element_text(hjust = 0.5))+ scale_x_continuous(breaks = seq(0, 10, by = 5))
pl
```


```{r}
pl <- dfPC %>% filter(gwas_type == "even" & test_type == "odd" & L == "pruneall") %>% ggplot(aes(x = PC, y = r2)) + geom_bar(stat = "identity", fill = "darkgreen", color = "darkgreen") + facet_grid(vars(gwas), vars(contrasts)) + theme_bw(base_size = 8) + ylab(TeX("$R_{K}^2$")) + geom_hline( aes(yintercept = 1-Error), color = "red", linetype = 2, linewidth = 1) + scale_x_continuous(breaks = seq(0, 40, by = 10)) + theme(axis.text.x = element_text(size = 6), plot.title = element_text(hjust = 0.5)) + ylim(-0.1,1)
pl
```

## Lat/long contrasts

Load data and format 
```{r}
dfOverlap <- fread("../endpoints/HGDP1KG/OverlapStats.txt") %>% separate(gwas, into = c("tmp", "gwas"), sep = "e")
dfOverlap$gwas <- factor(dfOverlap$gwas, levels = c( "5", "10", "50", "200")) 
dfOverlap <- dfOverlap %>% filter(contrasts %in% c("eurasia-lat", "eurasia-long", "eur-lat", "eur-long"))
#dfOverlap$contrasts <- factor(dfOverlap$contrasts, levels = c("eas-nfe","eas-sas","eas-afr", "eas-amr", "nfe-sas","nfe-afr", "nfe-amr","sas-afr", "sas-amr", "afr-amr"))
```

```{r}
dfPC <- fread("../endpoints/HGDP1KG/PCStats.txt") %>% separate(gwas, into = c("tmp", "gwas"), sep = "e")
dfPC$gwas <- factor(dfPC$gwas, levels = c("e5", "e10", "e50", "e200"))
dfPC <- dfPC %>% filter(contrasts %in% c("eurasia-lat", "eurasia-long", "eur-lat", "eur-long"))
```

```{r}
pl <- dfOverlap %>% filter(L == "pruneall")%>% ggplot(aes(x = gwas, y = Z)) + geom_point() + xlab("") + ylab("") + theme_bw(base_size = 14)  + guides(fill="none") + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 10))+facet_wrap(~contrasts, nrow = 1)+ scale_y_log10() 
pl
ggsave("~/Desktop/tmp.png", pl, height = 2, width = 12)
```















```{r}
dfQ <- fread("../endpoints/HGDP1KG/QStats.txt")

pl <- dfQ %>% filter(covar == "no-FGr", contrasts %in% c("eur-lat", "eur-long"))%>% ggplot(aes(x = gwas, y = q, fill = as.character(pc))) + geom_bar(stat="identity") + facet_grid(vars(pc),vars(contrasts)) + theme_bw(base_size = 10) + theme(axis.text.x = element_text(size = 6, angle =45), plot.title = element_text(hjust = 0.5), legend.position = "none")+ scale_fill_manual(values= c("pink4", "blue4"))
pl
ggsave("~/Desktop/tmp.png",pl,  height = 4)
```



